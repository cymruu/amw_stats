on:
  workflow_dispatch:
  push:
  schedule:
    - cron: '0 6 * * *'
jobs:
  stats_daily:
    runs-on: ubuntu-latest
    name: Trigger daily stats generation
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Cache Docker layers
        uses: actions/cache@v3
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-single-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-single-buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      - name: Set SINCE env
        run: echo "SINCE=$(date -d "yesterday 0" -u +"%Y-%m-%dT%H:%M:%SZ")" >> $GITHUB_ENV
      - name: Set UNTIL env
        run: echo "UNTIL=$(date -d "today 0" -u +"%Y-%m-%dT%H:%M:%SZ")" >> $GITHUB_ENV
      - run: docker build -t docker-export docker-export
      - name: Build docker-stats
        uses: docker/build-push-action@v3
        with:
          load: true
          context: docker-stats
          tags: docker-stats
          push: false
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new
      - run: docker build -t docker-imagemagick docker-imagemagick 
      - run: docker build -t docker-post docker-post 
      - name: Generate stats
        run: ./docker.sh
        env:
          SINCE: ${{ env.SINCE }}
          UNTIL: ${{ env.UNTIL }}
          PERIOD: "daily"
          AMW_STATS_MONGO_HOST: ${{ secrets.AMW_STATS_MONGO_HOST }}
          ACCOUNT_KEY: ${{ secrets.ACCOUNT_KEY }}
          APPKEY: ${{ secrets.APPKEY }}
          SECRET: ${{ secrets.SECRET }}
      # Temp fix
      # https://github.com/docker/build-push-action/issues/252
      # https://github.com/moby/buildkit/issues/1896
      - name: Move cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache
